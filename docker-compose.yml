version: "3.9"
services:
  mlflow:
    image: python:3.11-slim
    working_dir: /app
    volumes:
      - ./:/app
      - mlruns:/mlruns
    environment:
      - MLFLOW_TRACKING_URI=http://mlflow:5000
    command: >
      bash -lc "pip install --no-cache-dir mlflow==2.12.1 &&
      mkdir -p /mlruns/artifacts &&
      mlflow server --host 0.0.0.0 --port 5000
      --backend-store-uri sqlite:////mlruns/mlflow.db
      --artifacts-destination /mlruns/artifacts"
    ports:
      - "5000:5000"

  api:
    image: python:3.11-slim
    working_dir: /app
    volumes:
      - ./:/app
      - mlruns:/mlruns
    environment:
      - MLFLOW_TRACKING_URI=http://mlflow:5000
      - MODEL_NAME=sales-quantity-classifier
      - MODEL_ALIAS=@production
      - TRAIN_PROCESSED_PATH=data/processed/train.csv
    command: >
      bash -lc "pip install --no-cache-dir -r requirements.txt &&
      uvicorn serving.app:app --host 0.0.0.0 --port 8000"
    depends_on:
      - mlflow
    ports:
      - "8000:8000"

volumes:
  mlruns:
